<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="./style.css">
    <link href="https://fonts.googleapis.com/css?family=Josefin+Sans&display=swap" rel="stylesheet">
    <title>Deeter Cesler is your favorite person</title>

    <!-- Include from the CDN -->
    <script type="text/javascript" src="./html2canvas.js"></script>

</head>
<body>
    <div id="sloppy-wrapper">
        <div id="photo-box">
            <div id="app">
                <!-- <img id="uploaded" src="./default.png"> -->
            </div>
        </div>
        <br/>
        <br/>
        <form>
            <input type="file" name="upload" id="upload-photo"/>
        </form>
        <!-- Define the button 
        that will be used to 
        take the screenshot -->
        <button id="screenshot-button" disabled onclick="takeshot()">
            Take Screenshot
        </button>
        <br/>
        <br/>
        <div class="hero-wrapper" id="boi">
        </div>
        <script>

            let shotWidth = 600;

            function saveAs(uri, filename) {
                var link = document.createElement('a');

                if (typeof link.download === 'string') {
                    link.href = uri;
                    link.download = filename;

                    //Firefox requires the link to be in the body
                    document.body.appendChild(link);

                    //simulate click
                    link.click();

                    //remove the link when done
                    document.body.removeChild(link);
                } else {
                    window.open(uri);
                }


            }

  
            // Define the function 
            // to screenshot the div
            function takeshot() {
                let div =
                    document.getElementById('app');

                    console.log('takeshot')
                    console.log(shotWidth)

                // Use the html2canvas
                // function to take a screenshot
                // and append it
                // to the output div
                html2canvas(div, {
                    allowTaint: true,
                    default: false,
                    useCORS: true,
                    width: shotWidth
                }).then(function(canvas) {
                    saveAs(canvas.toDataURL(), 'canvas.png')})
            }

            const state = {
                uploadedImageSrc: "./default.png"
            }
            var form = document.querySelector('form');
            const imageArea = document.getElementById('app');
            // const image = document.getElementById("uploaded");
            let image;
            form.addEventListener('change', function(e) {
                console.log('change')
                state.uploadedImageSrc = URL.createObjectURL(event.target.files[0])
                console.log(state.uploadedImageSrc)
                const laserURL = "http://127.0.0.1:3001/lazer.png"
                const lazerWrapper = document.createElement("div")
                lazerWrapper.setAttribute("id","lazer-wrapper")
                if (!document.getElementById('uploaded')) {
                    image = new Image();
                    image.setAttribute('crossOrigin', 'anonymous');
                    image.setAttribute('id', 'uploaded');
                    imageArea.appendChild(lazerWrapper)
                    image.src = state.uploadedImageSrc;
                    imageArea.appendChild(image)
                } else image.src = state.uploadedImageSrc;

                document.getElementById("screenshot-button").disabled = false;

                // document.getElementById("uploaded").innerHTML = "<img id='uploaded' />"
                // const newHeight = image.clientHeight;
                // console.log(newHeight);
                // document.getElementById("photo-box").setAttribute("style", `height: ${newHeight + 20}px`);

                

                var xPosition;
                var yPosition;
                const laser1 = new Image()
                const laser2 = new Image()
                laser1.setAttribute('crossOrigin', 'anonymous');
                laser2.setAttribute('crossOrigin', 'anonymous');
                laser1.setAttribute('id',"one")
                laser2.setAttribute('id',"two")
                laser1.setAttribute('class',"laser")
                laser2.setAttribute('class',"laser")
                lazerWrapper.appendChild(laser1);
                lazerWrapper.appendChild(laser2);
                laser1.setAttribute('margin-left',"1000px")
                laser2.setAttribute('margin-left',"1000px")
                laser1.src = laserURL
                laser2.src = laserURL                
            

                let eye = "left"

                setTimeout(function(){
                    console.log('image.width')
                    console.log(imageArea.width)
                    shotWidth = image.clientWidth - (image.clientWidth * 0.05); //taking off 5% just to tighten it up
                    document.getElementById('photo-box').setAttribute('style',`max-width: ${image.width}px; max-height: ${image.height}px; padding: 0;`)
                    console.log(imageArea.width)
                }, 150);

                imageArea.addEventListener("click", getClickPosition, false);

                function toggleEye() {
                    if (eye === "left") eye = "right"
                    else eye = "left"
                }

                const placeLaser = (toggledEye) => {

                    if (toggledEye === "left") {
                        console.log('left')
                        laser1.style.left = xPosition + "px"
                        laser1.style.top = yPosition + "px"
                    } else {
                        console.log('right')
                        laser2.style.left = xPosition + "px"
                        laser2.style.top = yPosition + "px"
                    }
                }

                function getClickPosition(e) {
                    const bounds = image.getBoundingClientRect();
                    console.log(bounds)
                    console.log(e.clientX)
                    console.log('e.clientY')
                    console.log(e.clientY)
                    console.log('bounds top')
                    console.log(bounds.top)
                    // xPosition = (bounds.left);
                    // yPosition = (bounds.top);
                    // xPosition = e.clientX + (laser1.width /2);
                    // yPosition = e.clientY + (laser1.height/2);
                    const relativeXBoundary = e.clientX - bounds.left;
                    const relativeYBoundary = e.clientY - bounds.top;
                    xPosition = relativeXBoundary - (laser1.width /2) + 10;
                    yPosition = relativeYBoundary - (laser1.height/2) + 10;

                    placeLaser(eye)
                    toggleEye();
                }
            });
        </script>
    </div>
</body>
</html>